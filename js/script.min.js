let gData,gRegions=[];const LANG=$("html").attr("lang"),REGION_THRESHOLD=10,COLORS={default:"#3DC",carriers:"#3DC",cases:"#6DF",dead:"#EB8",discharged:"#9FC",serious:"#FEA",pcrtested:"#4CD",dark:"#399",selected:"#EC2",gender:{f:"#FE9",m:"#2B9"}},LABELS={ja:{change:"前日比",unit:{carriers:"名",cases:"名",discharged:"名",pcrtested:"名",serious:"名",dead:"名"},demography:{f:"女性",m:"男性"},age:{"10代":"10代","20代":"20代","30代":"30代","40代":"40代","50代":"50代","60代":"60代","70代":"70代","80代":"80代","90代":"90代","10歳未満":"10歳未満"}},en:{change:"DoD: ",unit:{carriers:"",cases:"",discharged:"",pcrtested:"",serious:"",dead:""},demography:{f:"Female",m:"Male"},age:{"10代":"10s","20代":"20s","30代":"30s","40代":"40s","50代":"50s","60代":"60s","70代":"70s","80代":"80s","90代":"90s","10歳未満":"Under 10"}}},init=()=>{const t=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),a=(a,e)=>{let s=a.find(".chart").empty().html("<canvas></canvas>").find("canvas")[0],o=a.find(".switch.selected").attr("value"),n=gData.transition[e],i=n[n.length-1][3],r=i-n[n.length-2][3];parseInt(r)>0&&(r="+"+r.toString());let l=a.find(".latest");l.find(".value").text(t(i)),l.find(".unit").text(LABELS[LANG].unit[e]),l.find(".type").text(a.find(".switch[value=total]").text()),l.find(".change").text(LABELS[LANG].change+" "+r);let d={type:"bar",data:{labels:[],datasets:[{label:a.find("h3:first").text(),backgroundColor:COLORS[e],data:[]}]},options:{aspectRatio:1.8,responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){let e=t[0].xLabel+" 12:00";"ja"===LANG&&(e+="時点"),"en"===LANG&&(e="As of "+e);return e+" "+a.find(".switch.selected").text()},label:function(a,s){return s.datasets[0].label+": "+t(s.datasets[0].data[a.index])+" "+LABELS[LANG].unit[e]}}},scales:{xAxes:[{stacked:!1,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{location:"bottom",stacked:!1,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,e,s){if(Math.floor(a)===a)return t(a.toString())}}}]}}};a.width()>=400&&(d.options.aspectRatio=2.4),n.forEach(function(t,a){if("total"===o)d.data.labels.push(t[1]+"/"+t[2]),d.data.datasets[0].data.push(t[3]);else if(a>=1){d.data.labels.push(t[1]+"/"+t[2]);let e=n[a-1];d.data.datasets[0].data.push(t[3]-e[3])}});let c=s.getContext("2d");window.myChart=new Chart(c,d)},e=t=>{let a="rgba(90, 90, 90, 0.3)";return t>=1&&(a=COLORS.dark),t>=10&&(a=COLORS.default),a},s=t=>{let a=$("#region-chart");a.empty(),a.html("<canvas></canvas>");let s=a.find("canvas")[0],o={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return t[0].yLabel},label:function(t,a){return t.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(t,a,e){return t.toString()}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};a.outerWidth()>=400&&(o.options.aspectRatio=.6),""!==t&&(o.options.animation.duration=0),gData.prefectures.forEach(function(a,s){a.value>=1&&(o.data.labels.push(a[LANG]),o.data.datasets[0].data.push(a.value),t===a.code?o.data.datasets[0].backgroundColor.push(COLORS.selected):o.data.datasets[0].backgroundColor.push(e(a.value)))});let n=s.getContext("2d");window.myChart=new Chart(n,o)};$.getJSON("data/data.json",function(t){gData=t,$(".transition-block").each(function(){let t=$(this).attr("code");a($(this),t)}),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let t={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.f,backgroundColor:COLORS.gender.f,data:[]},{label:LABELS[LANG].demography.m,backgroundColor:COLORS.gender.m,data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return t[0].yLabel},label:function(t,a){return a.datasets[t.datasetIndex].label+": "+t.value+{ja:"名",en:""}[LANG]}}},scales:{xAxes:[{position:"top",color:"yellow",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(t,a,e){return t.toString()}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)",callback:function(t){return LABELS[LANG].age[t]}}}]}}};$wrapper.outerWidth()>=400&&(t.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(t.options.aspectRatio=1.3);let a=0;for(let e in gData.demography){for(let s in gData.demography[e]){let o=gData.demography[e][s];0===a&&t.data.labels.push(s),t.data.datasets[a].data.push(o)}a++}let e=$canvas.getContext("2d");window.myChart=new Chart(e,t)})(),(()=>{const t=$("#japan-map").width();let a=[];gData.prefectures.forEach(function(t,s){a.push({code:t.code,jp:t.jp,en:t.en,color:e(t.value),hoverColor:COLORS.selected,prefectures:[t.code]})}),$("#japan-map").japanMap({areas:a,width:t,borderLineColor:"#fcfcfc",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,fontSize:11,onHover:function(t){console.log("a"),s(t.code,0)}})})(),s(""),["last","transition","demography","prefectures"].forEach(function(t){$(".updated-"+t).text(gData.updated[t][LANG])}),$("#container").addClass("show")}),$(".switch").on("click",function(){$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),a($(this).closest(".transition-block"),$(this).closest(".transition-block").attr("code"))}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")})};$(function(){init()});